package com.citi.gfts.erecon.config;

import javax.annotation.PostConstruct;

import org.springframework.context.annotation.Configuration;
import org.springframework.core.env.ConfigurableEnvironment;
import org.springframework.core.env.MutablePropertySources;
import org.springframework.core.env.PropertySource;

@Configuration
public class VaultPropertySourceRegistrar {

    @PostConstruct
    public void registerVaultPropertySource() {
        ConfigurableEnvironment env =
            (ConfigurableEnvironment) ApplicationContextProvider.getApplicationContext().getEnvironment();

        MutablePropertySources sources = env.getPropertySources();

        // **FIND THE CORRECT PROPERTY SOURCE**
        PropertySource<?> delegateSource = null;
        for (PropertySource<?> ps : sources) {
            if (ps.getName().contains("applicationConfig: [classpath:/application.properties]")) {
                delegateSource = ps;
                break;
            }
        }
        if (delegateSource == null) {
            throw new IllegalStateException("applicationConfig: [classpath:/application.properties] property source not found!");
        }

        System.out.println("Delegate property source for VaultPropertySource: " + delegateSource.getName());

        sources.addFirst(new VaultPropertySource("vaultPropertySource", delegateSource));
    }
}
